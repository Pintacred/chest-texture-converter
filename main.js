// UV MAPS
// SINGLE CHEST
const bedrock_chest_UVmap = {
    "bar_top": [1, 0, 2, 1],
    "bar_bottom": [3, 0, 2, 1],
    "bar_right": [0, 1, 1, 4],
    "bar_front": [1, 1, 2, 4],
    "bar_left": [3, 1, 1, 4],
    "bar_back": [4, 1, 2, 4],
    "lid_top": [14, 0, 14, 14],
    "lid_bottom": [28, 0, 14, 14],
    "lid_right": [0, 14, 14, 5],
    "lid_front": [14, 14, 14, 5],
    "lid_left": [28, 14, 14, 5],
    "lid_back": [42, 14, 14, 5],
    "container_top": [14, 19, 14, 14],
    "container_bottom": [28, 19, 14, 14],
    "container_right": [0, 33, 14, 10],
    "container_front": [14, 33, 14, 10],
    "container_left": [28, 33, 14, 10],
    "container_back": [42, 33, 14, 10]
};
const java_chest_UVmap = {
    "bar_bottom": [1, 0, 2, 1],
    "bar_top": [3, 0, 2, 1],
    "bar_right": [0, 1, 1, 4],
    "bar_back": [1, 1, 2, 4],
    "bar_left": [3, 1, 1, 4],
    "bar_front": [4, 1, 2, 4],
    "lid_bottom": [14, 0, 14, 14],
    "lid_top": [28, 0, 14, 14],
    "lid_right": [0, 14, 14, 5],
    "lid_back": [14, 14, 14, 5],
    "lid_left": [28, 14, 14, 5],
    "lid_front": [42, 14, 14, 5],
    "container_bottom": [14, 19, 14, 14],
    "container_top": [28, 19, 14, 14],
    "container_right": [0, 33, 14, 10],
    "container_back": [14, 33, 14, 10],
    "container_left": [28, 33, 14, 10],
    "container_front": [42, 33, 14, 10]
};
// DOUBLE CHEST
const bedrock_double_chest_UVmap = {
    "LEFT_bar_top": [2, 0, 1, 1],
    "LEFT_bar_bottom": [4, 0, 1, 1],
    // "LEFT_bar_right": [0, 1, 1, 4],
    "LEFT_bar_front": [2, 1, 1, 4],
    "LEFT_bar_left": [3, 1, 1, 4],
    "LEFT_bar_back": [4, 1, 1, 4],

    "LEFT_lid_top": [29, 0, 15, 14],
    "LEFT_lid_bottom": [59, 0, 15, 14],
    // "LEFT_lid_right": [0, 14, 14, 5],
    "LEFT_lid_front": [29, 14, 15, 5],
    "LEFT_lid_left": [44, 14, 14, 5],
    "LEFT_lid_back": [58, 14, 15, 5],

    "LEFT_container_top": [29, 19, 15, 14],
    "LEFT_container_bottom": [59, 19, 15, 14],
    // "LEFT_container_right": [0, 33, 14, 10],
    "LEFT_container_front": [29, 33, 15, 10],
    "LEFT_container_left": [44, 33, 14, 10],
    "LEFT_container_back": [58, 33, 15, 10],

    "RIGHT_bar_top": [1, 0, 1, 1],
    "RIGHT_bar_bottom": [3, 0, 1, 1],
    "RIGHT_bar_right": [0, 1, 1, 4],
    "RIGHT_bar_front": [1, 1, 1, 4],
    // "RIGHT_bar_left": [3, 1, 1, 4],
    "RIGHT_bar_back": [5, 1, 1, 4],

    "RIGHT_lid_top": [14, 0, 15, 14],
    "RIGHT_lid_bottom": [44, 0, 15, 14],
    "RIGHT_lid_right": [0, 14, 14, 5],
    "RIGHT_lid_front": [14, 14, 15, 5],
    // "RIGHT_lid_left": [44, 14, 14, 5],
    "RIGHT_lid_back": [73, 14, 15, 5],

    "RIGHT_container_top": [14, 19, 15, 14],
    "RIGHT_container_bottom": [44, 19, 15, 14],
    "RIGHT_container_right": [0, 33, 14, 10],
    "RIGHT_container_front": [14, 33, 15, 10],
    // "RIGHT_container_left": [44, 33, 14, 10],
    "RIGHT_container_back": [73, 33, 15, 10]
};
const java_double_chest_UVmap = {
    "LEFT_bar_bottom": [1, 0, 1, 1],
    "LEFT_bar_top": [2, 0, 1, 1],
    // "LEFT_bar_right": [0, 1, 1, 4],
    "LEFT_bar_back": [1, 1, 1, 4],
    "LEFT_bar_left": [2, 1, 1, 4],
    "LEFT_bar_front": [3, 1, 1, 4],

    "RIGHT_lid_bottom": [14, 0, 15, 14],
    "RIGHT_lid_top": [29, 0, 15, 14],
    // "LEFT_lid_right": [0, 14, 14, 5],
    "LEFT_lid_back": [14, 14, 15, 5],
    "LEFT_lid_left": [29, 14, 14, 5],
    "LEFT_lid_front": [43, 14, 15, 5],

    "RIGHT_container_bottom": [14, 19, 15, 14],
    "RIGHT_container_top": [29, 19, 15, 14],
    // "LEFT_container_right": [0, 33, 14, 10],
    "LEFT_container_back": [14, 33, 15, 10],
    "LEFT_container_left": [29, 33, 14, 10],
    "LEFT_container_front": [43, 33, 15, 10],

    "RIGHT_bar_bottom": [65, 0, 1, 1],
    "RIGHT_bar_top": [66, 0, 1, 1],
    "RIGHT_bar_right": [64, 1, 1, 4],
    "RIGHT_bar_back": [65, 1, 1, 4],
    // "RIGHT_bar_left": [66, 1, 1, 4],
    "RIGHT_bar_front": [67, 1, 1, 4],

    "LEFT_lid_bottom": [78, 0, 15, 14],
    "LEFT_lid_top": [93, 0, 15, 14],
    "RIGHT_lid_right": [64, 14, 14, 5],
    "RIGHT_lid_back": [78, 14, 15, 5],
    // "RIGHT_lid_left": [93, 14, 14, 5],
    "RIGHT_lid_front": [107, 14, 15, 5],

    "LEFT_container_bottom": [78, 19, 15, 14],
    "LEFT_container_top": [93, 19, 15, 14],
    "RIGHT_container_right": [64, 33, 14, 10],
    "RIGHT_container_back": [78, 33, 15, 10],
    // "RIGHT_container_left": [93, 33, 14, 10],
    "RIGHT_container_front": [107, 33, 15, 10]
};

// gameEdition and chestType conditions
// canvas SIZE controls
const gameEdition = document.getElementById("gameEdition");
const chestType = document.getElementById("chestType");

const canvasLabel1 = document.getElementById("canvasLabel1");
const canvasLabel2 = document.getElementById("canvasLabel2");

FileColumn2nd = document.getElementById("FileColumn2nd");

function checkCondition() {
    canvas2.width = resolutionActual;
    canvas2.height = resolutionActual;

    canvasMerge.width = (resolutionActual*2);
    canvasMerge.height = resolutionActual;

    canvasResultSecondLayer1.width = (resolutionActual);
    canvasResultSecondLayer1.height = (resolutionActual);

    canvasResultSecondLayer2.width = (resolutionActual);
    canvasResultSecondLayer2.height = (resolutionActual);

    // console.log("canvas2 width and height: " + canvas2.height);

    if (chestType.value === "doubleChest") {
        canvasResult.width = (resolutionActual*2);
        canvasResult.height = resolutionActual;

        FileColumn2nd.style.display = "";
        if (gameEdition.value === "javaToBedrock") {
            canvas1.width = resolutionActual;
            canvas1.height = resolutionActual;

            inputTexture2.disabled = false;
            canvasResult.style.display = "";
            canvasResultSecondLayer1.style.display = "none";
            canvasResultSecondLayer2.style.display = "none";

            canvasLabel1.textContent = "double chest (left side)";
            canvasLabel2.textContent = "double chest (right side)";

        } else if (gameEdition.value === "bedrockToJava") {
            canvas1.width = (resolutionActual*2);
            canvas1.height = resolutionActual;

            inputTexture2.disabled = true;
            FileColumn2nd.style.display = "none";
            canvasResult.style.display = "none";
            canvasResultSecondLayer1.style.display = "";
            canvasResultSecondLayer2.style.display = "";

            canvasLabel1.textContent = "double chest";
            canvasLabel2.textContent = "";
        }
    } else if (chestType.value === "singleChest") {
        canvasResult.style.display = "";
        canvasResult.width = resolutionActual;
        canvasResult.height = resolutionActual;
        canvasResultSecondLayer1.style.display = "none";
        canvasResultSecondLayer2.style.display = "none";
        FileColumn2nd.style.display = "none";
        canvas1.width = resolutionActual;
        canvas1.height = resolutionActual;

        canvasLabel1.textContent = "single chest";
        canvasLabel2.textContent = "";
    }
}



gameEdition.addEventListener("change", checkCondition);
chestType.addEventListener("change", checkCondition);

let inputResolution = document.getElementById("inputResolution");
inputResolution.addEventListener("input", changeRes);

resValueDisplay = document.getElementById("resValueDisplay");

let resolutionActual = 64;
let multiplesPower = resolutionActual/64;

function changeRes() {
    valueIndex = inputResolution.value - 1;
    resolutionActual = 2**(6+valueIndex);
    resValueDisplay.textContent = `${resolutionActual/4}x`;
    multiplesPower = resolutionActual/64;

    console.log("- - - - - - - - - - - - - - - - - - - - - - - -")
    console.log("resolutionActual: " + resolutionActual);
    console.log("multiplesPower: " + multiplesPower);
    console.log("valueIndex: " + valueIndex);
    console.log("resolution / 4 = " + (resolutionActual/4));
    checkCondition();
}

// canvas 1 only serves as a display for the inputted file and nothing else.
let canvas1 = document.getElementById("canvas1");
let ctx1 = canvas1.getContext("2d");

let img;
let inputTexture = document.getElementById("inputTexture");
inputTexture.addEventListener("change", (e) => {
    const file = inputTexture.files[0];
    if (!file) return;

    img = new Image();
    img.src = URL.createObjectURL(file);

    img.onload = () => {
        // Clear canvas and draw the image
        ctx1.clearRect(0, 0, canvas1.width, canvas1.height);
        ctx1.drawImage(img, 0, 0, canvas1.width, canvas1.height)
    }
});

// canvas 2 only serves as a display for the inputted file and nothing else.
let canvas2 = document.getElementById("canvas2");
let ctx2 = canvas2.getContext("2d");

let img2;
let inputTexture2 = document.getElementById("inputTexture2");
inputTexture2.addEventListener("change", (e) => {
    const file = inputTexture2.files[0];
    if (!file) return;

    img2 = new Image();
    img2.src = URL.createObjectURL(file);

    img2.onload = () => {
        // Clear canvas and draw the image
        ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
        ctx2.drawImage(img2, 0, 0, canvas2.width, canvas2.height)
    }
});

let canvasResult = document.getElementById("canvasResult");
let ctxResult = canvasResult.getContext("2d");

function convertPortion(w, h, x1, y1, x2, y2, imageFrom) {
    ctxResult.save();
    ctxResult.translate(w / 2, h / 2);      // Move to center of destination (0,0 + w/2, h/2)
    ctxResult.rotate(Math.PI);              // Rotate 180Â°
    ctxResult.translate(-w / 2, -h / 2);    // Move origin back to top-left of destination
    // x1, y1 are where the image is gonna go
    // x2, y2 are clipped portion of image ???
    // w, h are the image's size
    ctxResult.drawImage(imageFrom, x1, y1, w, h, -x2, -y2, w, h); // Draw at (0,0)
    ctxResult.restore();
}

function useUV(UVfrom, UVto, imageFrom) {
    for (const part in UVfrom) {
        if (UVto.hasOwnProperty(part)) {
            const editionOrigUV = UVfrom[part];
            const editionDestUV = UVto[part];

            // Destructure the arrays into individual variables
            const [OrigX, OrigY, w, h] = editionOrigUV;
            const [DestX, destY, UnusedW, UnusedH] = editionDestUV;

            // width, height, startX, startY, destX, destY
            convertPortion(
                (w*multiplesPower), (h*multiplesPower), 
                (OrigX*multiplesPower), (OrigY*multiplesPower), 
                (DestX*multiplesPower), (destY*multiplesPower), 
                imageFrom
            );

        }
    }
}


canvasResultSecondLayer1 = document.getElementById("canvasResultSecondLayer1");
ctxResultSecondLayer1 = canvasResultSecondLayer1.getContext("2d");
canvasResultSecondLayer2 = document.getElementById("canvasResultSecondLayer2");
ctxResultSecondLayer2 = canvasResultSecondLayer2.getContext("2d");

function splitTexture() {
    ctxResultSecondLayer1.drawImage(
        canvasResult,
        0, 0, resolutionActual, resolutionActual,
        0, 0, resolutionActual, resolutionActual
    );
    ctxResultSecondLayer2.drawImage(
        canvasResult,
        resolutionActual, 0, resolutionActual, resolutionActual,
        0, 0, resolutionActual, resolutionActual
    );
}

canvasMerge = document.getElementById("canvasMerge");
ctxMerge = canvasMerge.getContext("2d");

function mergeTexture(image, image2, intoImageCtx) {
    intoImageCtx.clearRect(0, 0, canvasMerge.width, canvasMerge.height);
    intoImageCtx.drawImage(image, 0, 0, resolutionActual, resolutionActual);
    intoImageCtx.drawImage(image2, resolutionActual, 0, resolutionActual, resolutionActual);
}


let convertBtn = document.getElementById("convertBtn");
convertBtn.addEventListener("click", function () {
    // clear the result's canvas first to prevent overlaying and to reset
    ctxResult.clearRect(0, 0, canvasResult.width, canvasResult.height);

    ctxResultSecondLayer1.clearRect(0, 0, canvasResult.width, canvasResult.height);
    ctxResultSecondLayer2.clearRect(0, 0, canvasResult.width, canvasResult.height);

    if (chestType.value === "singleChest") {
        // console.log("SINGLE CHEST")
        if (gameEdition.value === "bedrockToJava") {
            useUV(bedrock_chest_UVmap, java_chest_UVmap, img)
            // console.log("BEDROCK TO JAVA")
        }
        else if (gameEdition.value === "javaToBedrock") {
            useUV(java_chest_UVmap, bedrock_chest_UVmap, img)
            // console.log("JAVA TO BEDROCK")
        }
    }
    else if (chestType.value === "doubleChest") {
        // console.log("DOUBLE CHEST")
        if (gameEdition.value === "bedrockToJava") {
            useUV(bedrock_double_chest_UVmap, java_double_chest_UVmap, img)
            splitTexture();
            // console.log("BEDROCK TO JAVA")
        }
        else if (gameEdition.value === "javaToBedrock") {
            mergeTexture(img, img2, ctxMerge)
            useUV(java_double_chest_UVmap, bedrock_double_chest_UVmap, canvasMerge)
            // console.log("JAVA TO BEDROCK")
        }
    }
});




// DOWNLOADING THE IMAGES:
downloadBtn = document.getElementById("downloadBtn");

canvasDownload = document.getElementById("canvasDownload");


downloadBtn.addEventListener("click", function () {
    if (chestType.value === "singleChest") {
        const pngDataUrl = canvasResult.toDataURL("image/png");

        canvasDownload.href = pngDataUrl;
        canvasDownload.download = "converted_texture.png"; // Optional: set download filename
        canvasDownload.click();
        
    } else if (chestType.value === "doubleChest") {
        if (gameEdition.value === "bedrockToJava") {
            const pngDataUrl1 = canvasResultSecondLayer1.toDataURL("image/png");
            const pngDataUrl2 = canvasResultSecondLayer2.toDataURL("image/png");

            canvasDownload1.href = pngDataUrl1;
            canvasDownload1.download = "converted_texture_left_double.png"; // Optional: set download filename
            canvasDownload1.click();

            canvasDownload2.href = pngDataUrl2;
            canvasDownload2.download = "converted_texture_right_double.png"; // Optional: set download filename
            canvasDownload2.click();

        } else if (gameEdition.value === "javaToBedrock") {
            const pngDataUrl = canvasResult.toDataURL("image/png");

            canvasDownload.href = pngDataUrl;
            canvasDownload.download = "converted_texture_double.png"; // Optional: set download filename
            canvasDownload.click();
        }
    }
});
